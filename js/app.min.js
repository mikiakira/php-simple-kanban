jQuery(function(c){c("#card_label_color,#board_color,#board_new_color").spectrum({preferredFormat:"hex",showInput:true,showInitial:true,showPaletteOnly:true,palette:[["#ffffff","#cccccc","#999999","#666666","#333333","#000000"],["#f44336","#ff9800","#ffeb3b","#8bc34a","#4caf50","#03a9f4","#2196f3"]]});var b=c("[data-remodal-id=modal]").remodal();var a=c("[data-remodal-id=serach_result_modal]").remodal();function d(){b.open();setTimeout(function(){b.close()},3000)}c(".sortable").sortable();c(document).on("sortstop",".sortable",function(){var f=[];c(".pannel").each(function(h){var g=c(this).find("h2").attr("data-id");if(g!==""){f.push(g)}});var e=JSON.stringify(f);exePost("panels","sort","",e,"").done(function(){}).fail(function(){d()})});c(".panel-body").sortable({connectWith:".panel-body"});c(document).on("sortstop",".panel-body",function(){c(".pannel").each(function(g){var f=c(this).find("h2").attr("data-id");if(f!==""){var h=[];c("#panel_area .panel h2[data-id='"+f+"']").parent().parent().children(".panel-body").find(".card").each(function(j){var i=c(this).attr("cardid");if(i!==""){h.push(i)}});var e=JSON.stringify(h);exePost("cards","sort",f,e,"").done(function(){}).fail(function(){d()})}})});exePost("boards","first","","","").done(function(f){if(f){var e=c.parseJSON(f);c("#board_title h1").html(e.title);c("#board_title").attr("data-id",e.id);c("body").css("background-color",e.board_color);c("input#board_title_text").val(e.title);c("input#board_color").val(e.board_color);c("input#board_color").spectrum({showSelectionPalette:true,preferredFormat:"hex",showInput:true,showInitial:true,showPaletteOnly:true,palette:[["#ffffff","#cccccc","#999999","#666666","#333333","#000000"],["#f44336","#ff9800","#ffeb3b","#8bc34a","#4caf50","#03a9f4","#2196f3"]]});getPanels(e.id)}}).fail(function(e){d()});getBoardList();c(document).on("click","#board_all_list li",function(){var e=c(this).attr("data-board");getBoard(e)});c(document).on("click","#logout",function(){window.location.replace("logout.php")});c("#panel_add").on("click",function(g){var f=c(".pannel").length;if(f>7){alert("パネルを増やせるのは7個までです");return}c("#panel_area").append(c("#hidden .panel").html());c("#panel_area .panel-body").sortable({connectWith:".panel-body"});return false});c(document).on("click",".panel h2",function(){var e=c(this).attr("data-id");c("#panel-modal").attr("data-id",e);if(e==="new"){c("#panel-modal button#delete-btn").hide();c("#panel-modal #panel_title_text").val("")}else{c("#panel-modal button#delete-btn").show();c("#panel-modal #panel_title_text").val(c(this).html())}c("#panel-modal").modal("show")});c(document).on("click","#panel-modal .modal-dialog .modal-footer button#save-panel-btn",function(){var g=c("#panel_title_text").val();var e=c("#panel-modal").attr("data-id");var f=c("#board_title").attr("data-id");if((typeof e==="undefined")||(e==="")){e="new"}exePost("panels","save",e,g,f).done(function(i){var h=c.parseJSON(i);if(e==="new"){c("#panel_area .panel").find("h2[data-id='new']").eq(0).html(h.title);c("#panel_area .panel").find("h2[data-id='new']").eq(0).attr("data-id",h.id)}else{c("#panel_area .panel h2[data-id='"+e+"']").attr("data-id",h.id);c("#panel_area .panel h2[data-id='"+e+"']").html(h.title)}c("#panel-modal").modal("hide")}).fail(function(h){d()})});c(document).on("click","#panel-modal .modal-dialog .modal-footer button#delete-btn",function(){if(window.confirm("このパネルを削除します。よろしいですか？")){var e=c("#panel-modal").attr("data-id");exePost("panels","del",e,"","","","").done(function(){c("#panel_area .panel h2[data-id='"+e+"']").parent().parent().remove();c("#panel-modal").modal("hide")}).fail(function(){d()})}});c(document).on("click","#board_title h1",function(){c("#board-modal").modal("show")});c(document).on("click","#board_add",function(){c("#board_new_title_text").val("");c("#board_new_color").val("#000");c("#board-add-modal").modal("show")});c(document).on("click","#board-modal #save-btn",function(){var f=c("#board_title_text").val();var e=c("#board_color").val();var g=c("#board_title").attr("data-id");exePost("boards","save",g,f,e).done(function(i){var h=c.parseJSON(i);c("#board_title h1").html(h.title);c("body").css("background-color",h.board_color);c("input#board_title_text").val(h.title);c("#board_title").attr("data-id",h.id);getBoardList();c("#board-modal").modal("hide")}).fail(function(h){d()})});c(document).on("click","#board-add-modal #save-btn",function(){var f=c("#board_new_title_text").val();var e=c("#board_new_color").val();exePost("boards","save","new",f,e).done(function(h){var g=c.parseJSON(h);c("#board_title h1").html(g.title);c("body").css("background-color",g.board_color);c("input#board_title_text").val(g.title);c("#board_title").attr("data-id",g.id);c("#panel_area").html("");getBoardList();c("#board-add-modal").modal("hide")}).fail(function(g){d()})});c(document).on("click","#board-modal #delete-btn",function(){if(window.confirm("このボードを削除します。よろしいですか？")){var e=c("#board_title").attr("data-id");exePost("boards","del",e,"","","","").done(function(){exePost("boards","first","","","").done(function(g){var f=c.parseJSON(g);c("#board_title h1").html(f.title);c("#board_title").attr("data-id",f.id);c("body").css("background-color",f.board_color);c("input#board_title_text").val(f.title);c("input#board_color").val(f.board_color);getPanels(f.id)}).fail(function(f){d()});getBoardList();c("#board-modal").modal("hide")}).fail(function(){d()})}});c(document).on("click",".panel-body .card",function(){c("#card_title_text").val(c(this).html());c("#card-edit").attr("data-id",c(this).attr("cardId"));c("#card-edit").attr("card_panel_id",c(this).parent().parent().find(".panel-heading h2").attr("data-id"));c("#card_label_color").val(c(this).attr("label_color"));c("#card-move-modal").attr("data-id",c(this).attr("cardId"));if(c(this).attr("cardId")==="new"){c("#move-btn").hide();c("#delete-btn").hide();c("#card_title_text").val("");c("#contents").val("");c("#contents_view").html("");c("#card_label_color").val("#cccccc");c("#card_label_color").spectrum({showSelectionPalette:true,preferredFormat:"hex",showInput:true,showInitial:true,showPaletteOnly:true,palette:[["#ffffff","#cccccc","#999999","#666666","#333333","#000000"],["#f44336","#ff9800","#ffeb3b","#8bc34a","#4caf50","#03a9f4","#2196f3"]]})}else{c("#move-btn").show();c("#delete-btn").show();exePost("cards","find",c(this).attr("cardId"),"","","","").done(function(f){if(f){var e=c.parseJSON(f);c("#contents").val(e.contents);c("#contents_view").html(nl2br(e.contents)).linkify({target:"_blank"});c("#card_label_color").val(e.label_color);c("#card_label_color").spectrum({showSelectionPalette:true,preferredFormat:"hex",showInput:true,showInitial:true,showPaletteOnly:true,palette:[["#ffffff","#cccccc","#999999","#666666","#333333","#000000"],["#f44336","#ff9800","#ffeb3b","#8bc34a","#4caf50","#03a9f4","#2196f3"]]})}}).fail(function(e){d()});c("#contents").css("display","none");c("#contents_view").css("display","block")}c("#card-edit").modal("show")});c(document).on("click","#contents_toggle",function(){c("#contents_view").toggle();c("#contents").toggle();if(c("#contents_toggle").html()==="編集"){c("#contents_toggle").html("表示")}else{c("#contents_toggle").html("編集")}});c(document).on("click",".pannel .panel-footer .card_add",function(){c(this).parent().parent().children(".panel .panel-body").append(c('<div class="card panel panel-default" label_color="" cardid="new">New</div>'))});c(document).on("click","#card-edit .modal-dialog .modal-footer button#save-btn",function(){var j=c("#card_title_text").val();var h=c("#card_label_color").val();var g=c("#contents").val();var e=c("#card-edit").attr("data-id");var i=c("#board_title").attr("data-id");var f=c("#card-edit").attr("card_panel_id");if((typeof e==="undefined")||(e==="")){e="new"}exePost("cards","save",e,j,f,h,g).done(function(l){var k=c.parseJSON(l);var m=k.label_color;if(m==null){m=""}if(c("#panel_area .panel h2[data-id='"+f+"']").parent().parent().find(".panel-body .card[cardId='new']").length>0){c("#panel_area .panel h2[data-id='"+f+"']").parent().parent().find(".panel-body .card[cardId='new']:last-child").html(k.title);c("#panel_area .panel h2[data-id='"+f+"']").parent().parent().find(".panel-body .card[cardId='new']:last-child").attr("style","border-top: 12px solid "+m);c("#panel_area .panel h2[data-id='"+f+"']").parent().parent().find(".panel-body .card[cardId='new']:last-child").attr("cardID",k.id)}else{c(".card[cardId='"+k.id+"']").html(k.title);c(".card[cardId='"+k.id+"']").attr("style","border-top: 12px solid "+m)}c("#card_title_text").val("");c("#card_label_color").val("");c("#contents").val("");c("#card-edit").modal("hide")}).fail(function(k){d()})});c(document).on("click","#card-edit .modal-dialog .modal-footer button#delete-btn",function(){if(window.confirm("このカードを削除します。よろしいですか？")){var e=c("#card-edit").attr("data-id");var f=c("#card-edit").attr("card_panel_id");exePost("cards","del",e,"","","","").done(function(){c("#panel_area .panel h2[data-id='"+f+"']").parent().parent().find(".panel-body .card[cardId='"+e+"']").remove();c("#card-edit").modal("hide")}).fail(function(){d()})}});c(document).on("click","#card-edit .modal-dialog .modal-footer button#move-btn",function(){c("#card-move-modal").modal("show");c("#panel_select").html("");exePost("boards","list","","","").done(function(f){var g=c.parseJSON(f);var e="<option value=''>-</option>";c.each(g,function(h,i){e+="<option value='"+i.id+"'>"+i.title+"</option>"});c("#board_select").html("");c("#board_select").append(e);c("#card-move-modal .modal-dialog .modal-footer button#save-panel-btn").off("click");c("#card-move-modal .modal-dialog .modal-footer button#save-panel-btn").on("click",saveMovingCard)}).fail(function(){d()})});c(document).on("change","#board_select",function(){exePost("panels","list",c(this).val(),"","").done(function(f){if(f!==false){var g=c.parseJSON(f);var e="";c.each(g,function(h,i){e+="<option value='"+i.id+"'>"+i.title+"</option>"})}c("#panel_select").html("");c("#panel_select").append(e)}).fail(function(e){d()})});c(document).on("click","#searchExe",function(){var e=trim(c(".searchbox").val());if(e!=""){exePost("cards","search",e).done(function(g){if(g!="false"){var h=c.parseJSON(g);var f="";c.each(h,function(i,j){f+="<p><a card_id='"+j.id+"' panels_id='"+j.panels_id+"' boards_id='"+j.boards_id+"'>"+j.title+"</a></p>"});c("[data-remodal-id='serach_result_modal'] #searchResult").html(f);a.open()}else{c("[data-remodal-id='serach_result_modal'] #searchResult").html("<p>見つかりませんでした</p>");a.open()}}).fail(function(f){d()})}else{c(".searchbox").attr("placeholder","入力して下さい...");setTimeout(function(){c(".searchbox").attr("placeholder","Search for...")},2000)}});c(document).on("click","#searchResult a",function(){var e=c(this).attr("card_id");var g=c(this).attr("panels_id");var f=c(this).attr("boards_id");getBoard(f);a.close();setTimeout(function(){c("#panel_area .card[cardid="+e+"]").trigger("click")},3000)})});function saveMovingCard(){var a=$("#board_select").val();var d=$("#panel_select").val();var c=$("#card-move-modal").attr("data-id");var b=$("input[name='q']:radio:checked").val();exePost("cards",b,c,d,"","","").done(function(){$("#card-move-modal").modal("hide");$("#card-edit").modal("hide");$("#board_all_list li[data-board="+a+"]").trigger("click")}).fail(function(){msgTimeout()})}function getBoard(a){exePost("boards","find",a,"","").done(function(c){var b=$.parseJSON(c);$("#board_title h1").html(b.title);$("#board_title").attr("data-id",b.id);$("body").css("background-color",b.board_color);$("input#board_title_text").val(b.title);$("input#board_color").val(b.board_color);$("input#board_color").spectrum({showSelectionPalette:true,preferredFormat:"hex",showInput:true,showInitial:true,showPaletteOnly:true,palette:[["#ffffff","#cccccc","#999999","#666666","#333333","#000000"],["#f44336","#ff9800","#ffeb3b","#8bc34a","#4caf50","#03a9f4","#2196f3"]]});$("#panel_area").html("");getPanels(b.id)}).fail(function(b){alert("処理に時間がかかっています。しばらくしてからやり直してみて下さい")})}function exePost(f,c,g,e,b,a,d){return $.ajax({type:"POST",url:"pdo.php",dataType:"text",timeout:10000,data:{mode:f,action:c,id:g,label:a,title:e,contents:b,etc1:d}})}function nl2br(a){if(!a){}else{a=a.replace(/\r\n/g,"<br />");a=a.replace(/(\n|\r)/g,"<br />")}return a}function getBoardList(){$("#board_all_list").html("");exePost("boards","list","","","").done(function(b){var c=$.parseJSON(b);var a="<ul>";$.each(c,function(d,e){a+="<li class='list-group-item' data-board='"+e.id+"' style='background: 10px "+e.board_color+"'>"+e.title+"</li>"});a+="</ul>";$("#board_all_list").html(a)}).fail(function(a){msgTimeout()})}function getPanels(a){exePost("panels","list",a,"","").done(function(c){if(c!==false){var d=$.parseJSON(c);var b="";$.each(d,function(e,f){$("#panel_area").append($("#hidden .panel").html());$("#panel_area .panel:last-child h2").html(f.title);$("#panel_area .panel:last-child h2").attr("data-id",f.id);exePost("cards","list",f.id,"","").done(function(g){var h=$.parseJSON(g);var i="";$.each(h,function(j,k){i+="<div class='card panel panel-default' style='border-top: 12px solid "+k.label_color+"' label_color='"+k.label_color+"' cardId='"+k.id+"'>"+k.title+"</div>"});$("#panel_area .panel h2[data-id='"+f.id+"']").parent().parent().children(".panel-body").append(i);$("#panel_area .panel h2[data-id='"+f.id+"']").parent().parent().children(".panel-body").sortable({connectWith:".panel-body"})})})}}).fail(function(b){msgTimeout()})}function trim(b){var a=b.replace(/(^\s+)|(\s+$)/g,"");return a.replace(/(^\s )+|(\s+$)/g,"")};